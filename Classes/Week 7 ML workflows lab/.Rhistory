library(dplyr)
library(reshape2)
library(ggplot2)
library(lubridate)
library(randomForest)
# Data on species presence
species_data <- read.csv("raw_data/CATCH AND HAUL DATA .csv")
# Data on abiotic conditions at survey stations
haul_data <- read.csv("raw_data/HAUL_DATA.csv")
#### Time series of climate conditions in the Bering Sea ###
# spring time algae blooms
bloom_data <- read.csv("raw_data/bloom_timing.csv")
bloom_data <- bloom_data %>% mutate(Survey.year = year) %>%
select(Survey.year, north_south, globcolour_peak_mean) %>%
dcast(Survey.year~north_south)
names(bloom_data) <- c("Survey.year","blooms_north","blooms_south")
# sea ice cover
ice_data <- read.csv("raw_data/ice.csv") %>%
mutate(Survey.year = year) %>% select(-year)
species_data <- species_data %>%
filter(Taxon.common.name == "snow crab") %>%
select(Haul.ID,Number.CPUE..no.km2.)
species_data
# select haul IDs without the species
no_crab_Haul.IDs  <- haul_data$Haul.ID[!(haul_data$Haul.ID %in% species_data$Haul.ID )]
data_no_species <- data.frame(Haul.ID=no_crab_Haul.IDs,Number.CPUE..no.km2.=0 )
species_data <- rbind(data_no_species, species_data)
data <- merge(species_data, haul_data, by ="Haul.ID")%>%
select(Haul.ID,Bottom.temperature..degrees.Celsius.,
Surface.temperature..degrees.Celsius.,Depth..m.,
Survey.year,Start.latitude..decimal.degrees.,
Start.longitude..decimal.degrees.,Date.and.time,
Number.CPUE..no.km2. )
data$Day.of.year <- yday(dmy(substr(data$Date.and.time,1,11)))
data <- data %>% select(-Date.and.time)
head(data)
data <- merge(data,bloom_data,by = "Survey.year")%>%
merge(ice_data,by = "Survey.year")
data$presence <- data$Number.CPUE..no.km2. > 0.0
data <- data %>% select(-Number.CPUE..no.km2.)
X <- data %>% select(-Survey.year, -presence)
y <- data %>% select( Haul.ID, presence)
X <- as.data.frame(scale(X))
X$Haul.ID <- data$Haul.ID
data <- merge(y,X,by = "Haul.ID")
data <- na.omit(data)
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
library(caret)
tuneGrid <- expand.grid(.mtry = c(2,4,8))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence~ ., data = training , method = "rf",
trControl =trainControl, tuneGrid = tuneGrid)
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
library(dplyr)
library(reshape2)
library(ggplot2)
library(lubridate)
library(randomForest)
# Data on species presence
species_data <- read.csv("raw_data/CATCH AND HAUL DATA .csv")
# Data on abiotic conditions at survey stations
haul_data <- read.csv("raw_data/HAUL_DATA.csv")
#### Time series of climate conditions in the Bering Sea ###
# spring time algae blooms
bloom_data <- read.csv("raw_data/bloom_timing.csv")
bloom_data <- bloom_data %>% mutate(Survey.year = year) %>%
select(Survey.year, north_south, globcolour_peak_mean) %>%
dcast(Survey.year~north_south)
names(bloom_data) <- c("Survey.year","blooms_north","blooms_south")
# sea ice cover
ice_data <- read.csv("raw_data/ice.csv") %>%
mutate(Survey.year = year) %>% select(-year)
species_data <- species_data %>%
filter(Taxon.common.name == "snow crab") %>%
select(Haul.ID,Number.CPUE..no.km2.)
species_data
# select haul IDs without the species
no_crab_Haul.IDs  <- haul_data$Haul.ID[!(haul_data$Haul.ID %in% species_data$Haul.ID )]
data_no_species <- data.frame(Haul.ID=no_crab_Haul.IDs,Number.CPUE..no.km2.=0 )
species_data <- rbind(data_no_species, species_data)
data <- merge(species_data, haul_data, by ="Haul.ID")%>%
select(Haul.ID,Bottom.temperature..degrees.Celsius.,
Surface.temperature..degrees.Celsius.,Depth..m.,
Survey.year,Start.latitude..decimal.degrees.,
Start.longitude..decimal.degrees.,Date.and.time,
Number.CPUE..no.km2. )
data$Day.of.year <- yday(dmy(substr(data$Date.and.time,1,11)))
data <- data %>% select(-Date.and.time)
head(data)
data <- merge(data,bloom_data,by = "Survey.year")%>%
merge(ice_data,by = "Survey.year")
data$presence <- data$Number.CPUE..no.km2. > 0.0
data <- data %>% select(-Number.CPUE..no.km2.)
X <- data %>% select(-Survey.year, -presence)
y <- data %>% select( Haul.ID, presence)
X <- as.data.frame(scale(X))
X$Haul.ID <- data$Haul.ID
data <- merge(y,X,by = "Haul.ID")
data <- na.omit(data)
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
head(testing )
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
training <- training %>% mutate(as.factor(presence))
testing <- testing %>% mutate(as.factor(presence))
library(caret)
tuneGrid <- expand.grid(.mtry = c(2,4,8))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence~ ., data = training , method = "rf",
trControl =trainControl, tuneGrid = tuneGrid)
head(training)
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
training <- training %>% mutate(as.factor(presence))
testing <- testing %>% mutate(as.factor(presence))
library(caret)
tuneGrid <- expand.grid(.mtry = c(2,4,8))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence~ ., data = training , method = "rf",
trControl =trainControl, tuneGrid = tuneGrid)
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
training <- training %>% mutate(presence= as.factor(presence))
testing <- testing %>% mutate(presence=as.factor(presence))
library(caret)
tuneGrid <- expand.grid(.mtry = c(2,4,8))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence~ ., data = training , method = "rf",
trControl =trainControl, tuneGrid = tuneGrid)
library(pROC)
preds <- predict(mod, testing, type = "prob")
roc_obj <- roc(as.numeric(testing$presence)-1, preds$`TRUE`)
plot(roc_obj, main = "ROC Curve Example")
auc(roc_obj)
library(pROC)
preds <- predict(mod, testing, type = "prob")
roc_obj <- roc(as.numeric(testing$presence)-1, preds$`TRUE`)
plot(roc_obj, main = "ROC Curve Example")
auc(roc_obj)
library(ggplot2)
var_imp <- varImp(mod,useModel=F)
importance <- var_imp$importance
importance$variable <- rownames(importance)
ggplot(importance, aes(x = TRUE., y = variable))+
geom_point()+theme_classic()
library(pdp)
partial(mod, "Bottom.temperature..degrees.Celsius.", train = data,
prob = TRUE, which.class = "TRUE", plot = TRUE)
library(pdp)
partial(rf, "Depth..m.", train = data,
prob = TRUE, which.class = "TRUE", plot = TRUE)
library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(as.factor(presence == 2))
testing <- testing %>% mutate(as.factor(presence == 2))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(as.factor(presence) ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
head(training)
testing <- testing %>% mutate(presence=as.factor(presence == 2))
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 2))
testing <- testing %>% mutate(presence=as.factor(presence == 2))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(as.factor(presence) ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 2))
testing <- testing %>% mutate(presence=as.factor(presence == 2))
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 2))
testing <- testing %>% mutate(presence=as.factor(presence == 2))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(as.factor(presence) ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
head(testing )
library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 2))
testing <- testing %>% mutate(presence=as.factor(presence == 2))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
table(training$presence)
library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
table(data_sp$presence)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 1))
testing <- testing %>% mutate(presence=as.factor(presence == 1))
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
mod
library(pROC)
preds <- predict(mod, testing, type = "prob")
head9testing)
head(testing)
library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 1))
testing <- testing %>% mutate(presence=as.factor(presence == 1))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
mod
library(pROC)
preds <- predict(mod, testing, type = "prob")
roc_obj <- roc(as.numeric(testing$presence)-1, preds$`TRUE`)
plot(roc_obj, main = "ROC Curve Example")
auc(roc_obj)
library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
spatial_cv <- cv_spatial(x = sf_data, column = "presence", size = vario$range, k = 5)
testing <- data_sp[spatial_cv$folds_ids == 5,]
training <- data_sp[spatial_cv$folds_ids != 5,]
training <- training %>% mutate(presence=as.factor(presence == 1))
testing <- testing %>% mutate(presence=as.factor(presence == 1))
sf_training <- st_as_sf(training, coords = c(lon, lat), crs = 4326)
spatial_cv <- cv_spatial(x = sf_training, column = "presence", size = vario$range, k = 4)
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
mod <- train(presence ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
mod
library(pROC)
preds <- predict(mod, testing, type = "prob")
roc_obj <- roc(as.numeric(testing$presence)-1, preds$`TRUE`)
plot(roc_obj, main = "ROC Curve Example")
auc(roc_obj)
library(ggplot2)
var_imp <- varImp(mod,useModel=F)
importance <- var_imp$importance
importance$variable <- rownames(importance)
ggplot(importance, aes(x = TRUE., y = variable))+
geom_point()+theme_classic()
library(caret)
index_in <- lapply(spatial_cv$folds_list, `[[`, 1)
index_out <- lapply(spatial_cv$folds_list, `[[`, 2)
trainControl_blocks <- trainControl(
method = "cv",
number = length(index_in),
index  = index_in,
indexOut = index_out
)
tuneGrid <- expand.grid(.mtry = c(2, 5))
trainControl <- trainControl(method = "cv", number = 5)
training <- training %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.)
mod <- train(presence ~ ., data = training, method = "rf",
trControl = trainControl_blocks, tuneGrid = tuneGrid)
mod
library(pROC)
preds <- predict(mod, testing, type = "prob")
roc_obj <- roc(as.numeric(testing$presence)-1, preds$`TRUE`)
plot(roc_obj, main = "ROC Curve Example")
auc(roc_obj)
library(ggplot2)
var_imp <- varImp(mod,useModel=F)
importance <- var_imp$importance
importance$variable <- rownames(importance)
ggplot(importance, aes(x = TRUE., y = variable))+
geom_point()+theme_classic()
library(pdp)
partial(mod, "Depth..m.", train = df,
prob = TRUE, which.class = "TRUE", plot = TRUE)
library(pdp)
partial(mod, "Depth..m.", train = training,
prob = TRUE, which.class = "TRUE", plot = TRUE)
df <- data %>% select(-Start.latitude..decimal.degrees.,
-Start.longitude..decimal.degrees.,
- Haul.ID)
N <- nrow(df)
test_inds <- sample(1:N,round(N/5))
training <-df[test_inds,]
testing <-df[-test_inds,]
??caret::tuneGrid
??caret::train
tuneGrid
??caret::trainControl
trainControl
library(pROC)
??pROC
??pROC
??pROC::roc
library(ggplot2)
var_imp <- varImp(mod,useModel=F)
importance <- var_imp$importance
importance$variable <- rownames(importance)
ggplot(importance, aes(x = TRUE., y = variable))+
geom_point()+theme_classic()
#library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
detach("package:spdep", unload = TRUE)
#library(spdep)
library(blockCV)
library(sf)
library(dplyr)
lat <- "Start.latitude..decimal.degrees."
lon <- "Start.longitude..decimal.degrees."
data_sp <- data %>% mutate(presence = as.numeric(presence ))
sf_data <- st_as_sf(data_sp, coords = c(lon, lat), crs = 4326)
vario <- cv_spatial_autocor(
x = sf_data,
column = "presence",
progress = T, plot = T
)
plot(vario$variograms[[1]]$exp_var$dist, vario$variograms[[1]]$exp_var$gamma)
sf_data
type(sf_data)
typeof(sf_data)
??sf::st_as_sf
?caret::train
